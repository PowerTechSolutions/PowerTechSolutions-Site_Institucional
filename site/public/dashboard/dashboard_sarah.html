<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento - Processos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="dashboard_sarah.css">
    <script src="../js/direcoes.js"></script>

</head>

<body>
    <!-- inicio sidebar -->

    <!-- <div class="minimenu"></div>
    <div class="sidebar">
        <ul>
            <li class="logo" style="--bg: #333;">
                <a href="#">
                    <div class="icon">
                    </div>
                    <div class="text">PowerTech</div>
                </a>
            </li>
            <div class="listmenu">
                <li style="--bg: #F7E11B;" class="active">
                    <a href="#">
                        <div class="icon"><ion-icon name="analytics-outline"></ion-icon></div>
                        <div class="text">Geral</div>
                    </a>
                </li>
                <li style="--bg: #F7E11B;">
                    <a href="#">
                        <div class="icon"><ion-icon name="cube-outline"></ion-icon></div>
                        <div class="text">MFs</div>
                    </a>
                </li>
                <li style="--bg: #F7E11B;">
                    <a href="#">
                        <div class="icon"><ion-icon name="wallet-outline"></ion-icon></div>
                        <div class="text">VMs</div>
                    </a>
                </li>
                <li style="--bg: #F7E11B;">
                    <a href="#">
                        <div class="icon"><ion-icon name="people-outline"></ion-icon></div>
                        <div class="text">Adicionar Permiss칫es</div>
                    </a>
                </li>
                <li style="--bg: #F7E11B;">
                    <a href="#">
                        <div class="icon"><ion-icon name="person-add-outline"></ion-icon></div>
                        <div class="text">Adicionar Usuario</div>
                    </a>
                </li>
                <li style="--bg: #F7E11B;">
                    <a href="#">
                        <div class="icon"><ion-icon name="help-circle-outline"></ion-icon></div>
                        <div class="text">Central de Ajuda</div>
                    </a>
                </li>
            </div>
            <div class="pessoa">
                <li style="--bg: #333;">
                    <a href="#">
                        <div class="icon">
                            <div class="imgBx">
                                <img src="dash_pt/usuario_redondo.png" alt="">
                            </div>
                        </div>
                        <div class="text">Undefined</div>
                    </a>
                </li>
                <li style="--bg: #333;">
                    <a href="#">
                        <div class="icon"><ion-icon name="log-out-outline"></ion-icon></div>
                        <div class="text">Sair</div>
                    </a>
                </li>
            </div>
        </ul>
    </div> -->

    <!-- fim sidebar -->

    <!-- inicio do conte칰do da p치gina -->

    <div class="foraside">
        <div class="topo">

            <div class="bvolta">
                <button style="cursor: pointer;" onclick="geral()"><img src="../assets/imgs_power/arrow.png"
                    alt=""></button>
            </div>

            <div class="apenastitulo">
                <span>Monitoramento de Processos</span>
            </div>

        </div>

        <div class="first-container">

            <div class="kpi kp2">
                <h3>Processos Atuais Est치veis</h3>
                <div id="kpiEstavel" class="numbers">
                    <!-- <span>  </span> -->
                </div>
            </div>
            <div class="kpi kp3">
                <h3>Numera칞칚o da M치quina</h3>
                <div id="numeroMaquina" class="numbers">
                    <!-- <span> 2 </span> -->
                </div>
            </div>
        </div>

        <div class="second-container">
            <div class="quadro">
                <h3>Registro de Processos</h3>
                <div class="info-r">
                    <span>NOME</span>
                    <span>DATA HORA</span>
                    <span>STATUS</span>
                </div>
                <div class="registro-container" id="registro-container">
                    <!-- <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <svg fill="#171616" height="5vh" width="5vw" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-49.36 -49.36 592.36 592.36" xml:space="preserve">

                            <path d="M421.428,72.476C374.868,25.84,312.86,0.104,246.724,0.044C110.792,0.044,0.112,110.624,0,246.548 c-0.068,65.912,25.544,127.944,72.1,174.584c46.564,46.644,108.492,72.46,174.4,72.46h0.58v-0.048 c134.956,0,246.428-110.608,246.556-246.532C493.7,181.12,468,119.124,421.428,72.476z M257.516,377.292 c-2.852,2.856-6.844,4.5-10.904,4.5c-4.052,0-8.044-1.66-10.932-4.516c-2.856-2.864-4.496-6.852-4.492-10.916 c0.004-4.072,1.876-8.044,4.732-10.884c2.884-2.86,7.218-4.511,11.047-4.542c3.992,0.038,7.811,1.689,10.677,4.562 c2.872,2.848,4.46,6.816,4.456,10.884C262.096,370.46,260.404,374.432,257.516,377.292z M262.112,304.692 c-0.008,8.508-6.928,15.404-15.448,15.404c-8.5-0.008-15.42-6.916-15.416-15.432L231.528,135 c0.004-8.484,3.975-15.387,15.488-15.414c4.093,0.021,7.895,1.613,10.78,4.522c2.912,2.916,4.476,6.788,4.472,10.912 L262.112,304.692z"/> 
                        
                        </svg>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游댮 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游댮 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游리 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游릭 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游릭 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游댮 </span>
                    </div>
                    <div class="tuplas">
                        <span>Adom.com</span>
                        <span> 23/05/2023 12:30</span>
                        <span> 游리 </span>
                    </div>  -->
                </div>
            </div>

            <div class="picos">

                <div class="t-grafico">
                    <span></span>
                </div>

                <div>
                    <canvas class="myChart1" id="myChart1"></canvas>
                </div>


                <script src="../js/grafico_sarah.js"></script>

                <script>

                    window.onload = async function () {

                        try {

                            await obterDadosGrafico_picos
                            await atualizarGrafico_picos

                        } catch (error) {
                            console.error(`Erro na obten칞칚o dos dados p/ gr치fico: ${error.message}`);
                        }
                    }

                    // const ctx = document.getElementById('myChart');


                    // const resposta = [
                    //     { momento_grafico: 'Segunda', total_cpu: 12, total_ram: 5 },
                    //     { momento_grafico: 'Ter칞a', total_cpu: 19, total_ram: 8 },
                    //     { momento_grafico: 'Quarta', total_cpu: 3, total_ram: 2 },
                    //     { momento_grafico: 'Quinta', total_cpu: 5, total_ram: 6 },
                    //     { momento_grafico: 'Sexta', total_cpu: 2, total_ram: 7 },
                    //     { momento_grafico: 'S치bado', total_cpu: 3, total_ram: 4 },
                    //     { momento_grafico: 'Domingo', total_cpu: 8, total_ram: 9 },
                    // ];


                    // let labels = [];

                    // let dados = {
                    //     labels: labels,
                    //     datasets: [{
                    //         label: 'Total CPU',
                    //         data: [],
                    //         backgroundColor: '#ffff2b', //barra cpu
                    //         borderWidth: 1,
                    //     },
                    //     {
                    //         label: 'Total RAM',
                    //         data: [],
                    //         backgroundColor: '#ffff7a', //barra ram
                    //         borderWidth: 1,
                    //     }]
                    // };

                    // for (let i = 0; i < resposta.length; i++) {
                    //     const registro = resposta[i];
                    //     labels.push(registro.momento_grafico);
                    //     dados.datasets[0].data.push(registro.total_cpu);
                    //     dados.datasets[1].data.push(registro.total_ram);
                    // }

                    // new Chart(ctx, {
                    //     type: 'bar',
                    //     data: dados,
                    //     options: {
                    //         scales: {
                    //             y: {
                    //                 beginAtZero: true
                    //             }
                    //         }
                    //     }
                    // });
                </script>
            </div>
        </div>

        <div class="espaco">

            <div class="monitor">
                <h4>Monitor de Desempenho Cr칤tico Atual</h4>
                <div class="info-m">
                    <span>ALERTA</span>
                    <span>NOME</span>
                    <span>USO CPU</span>
                    <span>USO RAM</span>
                    <!-- <span>EDITAR</span> -->
                </div>
                <div class="table-container" id="table-container">

                </div>
            </div>
        </div>

    </div>

    </div>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>

        quantidadeEstavel()

        function quantidadeEstavel() {
            fetch("/processo/quantidadeEstavel", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },

            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var kpiqtdEstavel = document.getElementById("kpiEstavel");
                        for (let contador_usuario = 0; contador_usuario < resposta.length; contador_usuario++) {
                            var publicacao = resposta[contador_usuario];

                            // var numbers = document.createElement("h3");
                            kpiqtdEstavel.innerHTML = publicacao.alertaVerde;
                            // numbers.appendChild(qtdEstavel)
                            // numbers.className = "numbers";
                            // kpi.appendChild(numbers)

                        }
                    });
                } else {
                    throw ("Houve um erro ao tentar realizar A pesquisa!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                //finalizarAguardar();
            });
        }

        maquinaNumber()

        function maquinaNumber() {
            fetch("/processo/maquinaNumber", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },

            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var kpiMaquina = document.getElementById("numeroMaquina");
                        for (let contador_usuario = 0; contador_usuario < resposta.length; contador_usuario++) {
                            var publicacao = resposta[contador_usuario];

                            // var numeroMaquina = document.createElement("span");
                            kpiMaquina.innerHTML = publicacao.qtdMaquina;
                            // numbers.appendChild(numeroMaquina)

                        }
                    });
                } else {
                    throw ("Houve um erro ao tentar realizar A pesquisa!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                //finalizarAguardar();
            });
        }

        
        setTimeout(() => atualizarProcessosDinamico(), 5000)
        function atualizarProcessosDinamico(){
                const listaTuplasProcessos = document.querySelector("#registro-container").children
                const listaTuplasAlertas = document.querySelector("#table-container").children
                limparTuplas(listaTuplasProcessos)
                limparTuplas(listaTuplasAlertas),
                PegarProcessosAtuais(),
                ListarCriticos(),
                setTimeout(() => atualizarProcessosDinamico(), 2000)
        }

        PegarProcessosAtuais()
        function PegarProcessosAtuais() {

            fetch("/processo/ExibirUltimosProcessos", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },

            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var tabela = document.getElementById("registro-container");
                        for (let contador_usuario = 0; contador_usuario < resposta.length; contador_usuario++) {
                            var publicacao = resposta[contador_usuario];

                            var tupla = document.createElement("div");
                            tupla.className = "tuplas";

                            var nameProcesso = document.createElement("span");
                            nameProcesso.innerHTML = publicacao.nomeProcesso;
                            tupla.appendChild(nameProcesso)

                            var dataHora = document.createElement("span");
                            dataHora.innerHTML = publicacao.data_formatada;
                            tupla.appendChild(dataHora);

                            var alert_svg = document.createElementNS("http://www.w3.org/2000/svg", "svg")
                            alert_svg.setAttribute("witdh", "5vw")
                            alert_svg.setAttribute("height", "5vh")
                            alert_svg.setAttribute("viewBox", "-49.36 -49.36 592.36 592.36")

                            var statusFinal = validarStatusFinal(publicacao.cpu_processo, publicacao.uso_ram)
                            alert_svg.setAttribute("fill", validarCoresSvg(statusFinal))

                            var path = document.createElementNS("http://www.w3.org/2000/svg", "path")
                            path.setAttribute("d", "M421.428,72.476C374.868,25.84,312.86,0.104,246.724,0.044C110.792,0.044,0.112,110.624,0,246.548 c-0.068,65.912,25.544,127.944,72.1,174.584c46.564,46.644,108.492,72.46,174.4,72.46h0.58v-0.048 c134.956,0,246.428-110.608,246.556-246.532C493.7,181.12,468,119.124,421.428,72.476z M257.516,377.292 c-2.852,2.856-6.844,4.5-10.904,4.5c-4.052,0-8.044-1.66-10.932-4.516c-2.856-2.864-4.496-6.852-4.492-10.916 c0.004-4.072,1.876-8.044,4.732-10.884c2.884-2.86,7.218-4.511,11.047-4.542c3.992,0.038,7.811,1.689,10.677,4.562 c2.872,2.848,4.46,6.816,4.456,10.884C262.096,370.46,260.404,374.432,257.516,377.292z M262.112,304.692 c-0.008,8.508-6.928,15.404-15.448,15.404c-8.5-0.008-15.42-6.916-15.416-15.432L231.528,135 c0.004-8.484,3.975-15.387,15.488-15.414c4.093,0.021,7.895,1.613,10.78,4.522c2.912,2.916,4.476,6.788,4.472,10.912 L262.112,304.692z")
                            alert_svg.appendChild(path)
                            tupla.appendChild(alert_svg)

                            // tupla.setAttribute("onclick", `editar(${publicacao.pid})`);

                            tabela.appendChild(tupla)
                        }
                    });
                } else {
                    throw ("Houve um erro ao tentar realizar A pesquisa!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                //finalizarAguardar();
            });


        }

        function limparTuplas(listaTuplas){
            for(tupla of listaTuplas){
                tupla.remove()
            }
        }



        function validarCoresSvg(statusFinal) {
            if (statusFinal == 3) {
                return "#FF0000"
            }

            if (statusFinal == 2) {
                return "#FFFF00"
            }

            if (statusFinal == 1) {
                return "#32CD32"
            }
        }


        function validarStatusFinal(cpu, ram) {
            const statusCpu = validarStatusCpu(cpu)
            const statusRam = validarStatusRam(ram)

            var maiorValor = statusCpu
            if (statusRam > maiorValor) {
                maiorValor = statusRam
            }

            return maiorValor
        }

        function validarStatusCpu(porcentagemCpu) {
            if (porcentagemCpu >= 12.2) {
                return 3
            }
            else if (porcentagemCpu >= 8.0) {
                return 2
            }
            else if (porcentagemCpu <= 7.9) {
                return 1
            }
        }

        function validarStatusRam(porcentagemRam) {
            if (porcentagemRam >= 90.0) {
                return 3
            }
            else if (porcentagemRam >= 87.0) {
                return 2
            }
            else if (porcentagemRam <= 86.9) {
                return 1
            }
        }

        ListarCriticos()
        function ListarCriticos() {

            fetch("/processo/ListarCriticos", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },

            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", resposta);


                        var tabela_criticos = document.getElementById("table-container");
                        for (let contador_usuario = 0; contador_usuario <= resposta.length - 1; contador_usuario++) {
                            var listagem = resposta[contador_usuario];



                            var contador = 0
                            const listaServicosSistema = ["Code.exe", "RuntimeBroker.exe", "java.exe", "SystemSettingsBroker.exe", "svchost.exe"]
                            for (let i = 0; i <= listaServicosSistema.length - 1; i++) {
                                var nomeProcesso = listagem.nomeProcesso
                                if (nomeProcesso == listaServicosSistema[i]) {
                                    contador++
                                }
                            }

                            if (contador == 0) {
                                if (listagem.tipo_alerta != 1 && listagem.tipo_alerta != 2) {
                                    var lines = document.createElement("div");
                                    lines.className = "lines";

                                    var alert_svg = document.createElementNS("http://www.w3.org/2000/svg", "svg")
                                    alert_svg.setAttribute("witdh", "5vw")
                                    alert_svg.setAttribute("height", "5vh")
                                    alert_svg.setAttribute("viewBox", "-49.36 -49.36 592.36 592.36")

                                    var statusFinal = validarStatusFinal(listagem.cpu_processo, listagem.uso_ram)
                                    var tipoAlerta = listagem.tipo_alerta
                                    alert_svg.setAttribute("fill", validarCoresSvg(tipoAlerta))

                                    var path = document.createElementNS("http://www.w3.org/2000/svg", "path")
                                    path.setAttribute("d", "M421.428,72.476C374.868,25.84,312.86,0.104,246.724,0.044C110.792,0.044,0.112,110.624,0,246.548 c-0.068,65.912,25.544,127.944,72.1,174.584c46.564,46.644,108.492,72.46,174.4,72.46h0.58v-0.048 c134.956,0,246.428-110.608,246.556-246.532C493.7,181.12,468,119.124,421.428,72.476z M257.516,377.292 c-2.852,2.856-6.844,4.5-10.904,4.5c-4.052,0-8.044-1.66-10.932-4.516c-2.856-2.864-4.496-6.852-4.492-10.916 c0.004-4.072,1.876-8.044,4.732-10.884c2.884-2.86,7.218-4.511,11.047-4.542c3.992,0.038,7.811,1.689,10.677,4.562 c2.872,2.848,4.46,6.816,4.456,10.884C262.096,370.46,260.404,374.432,257.516,377.292z M262.112,304.692 c-0.008,8.508-6.928,15.404-15.448,15.404c-8.5-0.008-15.42-6.916-15.416-15.432L231.528,135 c0.004-8.484,3.975-15.387,15.488-15.414c4.093,0.021,7.895,1.613,10.78,4.522c2.912,2.916,4.476,6.788,4.472,10.912 L262.112,304.692z")
                                    alert_svg.appendChild(path)
                                    lines.appendChild(alert_svg)

                                    var nomeProcesso = document.createElement("span");
                                    nomeProcesso.innerHTML = listagem.nomeProcesso;
                                    lines.appendChild(nomeProcesso)

                                    var porcentagem_cpu = document.createElement("span");
                                    porcentagem_cpu.innerHTML = `${listagem.cpu_processo}%`;
                                    lines.appendChild(porcentagem_cpu)

                                    var porcentagem_ram = document.createElement("span");
                                    porcentagem_ram.innerHTML = `${listagem.uso_ram}%`;
                                    lines.appendChild(porcentagem_ram)

                                    // var spanButton = document.createElement("span")
                                    // spanButton.id = "spanMatarProcesso"

                                    //     var pid = listagem.PID
                                    //     spanButton.innerHTML = `
                                    //     <button id="${pid}" onclick="matarProcesso(this.id)">Matar Processo</button>
                                    // `
                                    // lines.appendChild(spanButton)

                                    tabela_criticos.appendChild(lines)
                                }
                            }


                        }
                    });
                } else {
                    throw ("Houve um erro ao tentar realizar A pesquisa!");
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });


        }



        // if (contador == 0) {

        // }

        // function matarProcesso(pid) {

        //     fetch(`/processo/matarProcesso/${pid}`, {
        //         method: "POST",
        //         headers: {
        //             "Content-Type": "application/json"
        //         },

        //     }).then(function (resposta) {

        //         console.log("resposta: ", resposta);

        //         if (resposta.ok) {

        //             resposta.json().then(function (resposta) {
        //                 console.log("Resposta recebida: ", resposta);

        //             });
        //         } else {
        //             throw ("Houve um erro ao tentar realizar A pesquisa!");
        //         }
        //     }).catch(function (resposta) {
        //         console.log(`#ERRO: ${resposta}`);
        //     });

        // }



    </script>

</body>

</html>